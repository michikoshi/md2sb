"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const html2sb_compiler_1 = require("html2sb-compiler");
exports.default = async (uploadImage, input, options) => {
    let xmlString = input;
    if (typeof input === "object") {
        if (input instanceof Buffer) {
            xmlString = input.toString();
        }
        else if (typeof input !== "string") {
            throw new Error("It allows string or buffer");
        }
    }
    const allNotes = (0, html2sb_compiler_1.parse)(xmlString, { evernote: true });
    return await Promise.all(allNotes.map(async (noteTokens) => {
        if (noteTokens.resources) {
            await Promise.all(Object.keys(noteTokens.resources)
                .map(async (resourceKey) => {
                const resource = noteTokens.resources[resourceKey];
                const mimeType = resource.mime;
                if (/^image\/.*/.test(mimeType)) {
                    const file = new Buffer(resource.data, "base64");
                    const res = await uploadImage(file, options);
                    noteTokens.resources[resourceKey] = {
                        type: "img",
                        href: resource.href,
                        src: res.data.permalink_url,
                    };
                }
            })
                .filter(Boolean));
        }
        const sb = (0, html2sb_compiler_1.toScrapbox)(noteTokens);
        sb.title = (0, html2sb_compiler_1.guessTitle)(noteTokens, sb, (_pageTokens, foundTitle, template) => {
            const named = "Untitled";
            return foundTitle || template(named) || named;
        });
        return sb;
    }));
};
//# sourceMappingURL=main.js.map